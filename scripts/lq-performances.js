// ==UserScript==
// @name         perf
// @namespace    http://tampermonkey.net/
// @version      1.4
// @match        https://my.learnquraan.co.uk/employees/teacher/lesson-step1*
// @match        https://my.learnquraan.co.uk/employees/teacher/lesson-step2*
// @grant        GM_addStyle
// @run-at       document-idle
// ==/UserScript==

(()=>{"use strict";document.head.insertAdjacentHTML("beforeend",'<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;600;800&display=swap" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">');const hid=new URLSearchParams(location.search).get("history_id")||document.querySelector('input[name="history1"]')?.value||"";let h=document.querySelector(".box-title")?.textContent.trim()||"",name="";if(h){if(location.href.includes("lesson-step1"))name=(h.match(/^(.+?)\s+'s\s+Lesson Details$/)||[])[1]||"";else name=(h.match(/^(.+?)\s+'s\s+Additional Lesson Details$/)||[])[1]||""}const L=k=>{try{return JSON.parse(localStorage.getItem(k)||"[]")}catch{return[]}},S=(k,v)=>localStorage.setItem(k,JSON.stringify(v));let students=L("listOfStudents"),i=students.findIndex(x=>x[hid]);let pref=i>-1?students[i][hid]:{name,panelOpen:true};if(typeof pref==="string")pref={name:pref,panelOpen:true};i>-1?students[i][hid]=pref:students.push({[hid]:pref});S("listOfStudents",students);const R=()=>{let d=new Date(),m=d.getMinutes()<30?"00":"30";return d.getFullYear()+(""+(d.getMonth()+1)).padStart(2,0)+(""+d.getDate()).padStart(2,0)+(""+d.getHours()).padStart(2,0)+m};let cur;try{cur=JSON.parse(localStorage.getItem("currentClass"))}catch{}if(!cur||cur.history_id!==hid||cur.time!==R())cur={history_id:hid,time:R(),complements:{p:Array(9).fill(0),n:Array(9).fill(0)}},localStorage.setItem("currentClass",JSON.stringify(cur));const P={1:"Nice",2:"Good",3:"Cool",4:"Great",5:"Awesome",6:"Amazing",7:"Wow",8:"Marvelous",9:"Spectacular"},N={1:"Oh",2:"Oops",3:"Uh-oh",4:"Hmm",5:"Ehh",6:"Oopsie",7:"Whoops",8:"Aaugh",9:"Yikes"},PC={1:"#0f766e",2:"#166534",3:"#1e40af",4:"#b45309",5:"#b91c1c",6:"#be185d",7:"#7c3aed",8:"#6d28d9",9:"#b7791f"},NC={1:"#4b5563",2:"#6b7280",3:"#2563eb",4:"#1e40af",5:"#6d28d9",6:"#9d174d",7:"#c026d3",8:"#ef4444",9:"#7f1d1d"};let c={p:{},n:{}},score=50;for(let j=1;j<=9;j++)c.p[j]=cur.complements.p[j-1],c.n[j]=cur.complements.n[j-1],score+=c.p[j]*j-c.n[j]*j;const site=document.createElement("div");site.id="site";while(document.body.firstChild)site.appendChild(document.body.firstChild);document.body.appendChild(site);const panel=document.createElement("div");panel.id="panel";panel.innerHTML=`<div id=close>âœ•</div><div id=name><i class="fa-regular fa-user"></i>${name}</div><div id=timer><i class="fa-regular fa-clock"></i><span>00:00</span></div><div id=box><div class=l>STUDENT SCORE</div><div id=score>${score}</div></div><div id=lists><div><h3>ğŸŒŸ Positive</h3><div id=pos></div></div><div><h3>âš ï¸ Needs Work</h3><div id=neg></div></div></div>`;document.body.appendChild(panel);const mini=document.createElement("div");mini.id="mini";mini.innerHTML='<i class="fa-solid fa-chart-simple"></i>';document.body.appendChild(mini);const toast=document.createElement("div");toast.id="toast";site.appendChild(toast);GM_addStyle(`html,body{margin:0;font-family:Play}#site{padding:12px;min-height:100vh;transition:.3s}#panel{position:fixed;right:0;top:0;width:20vw;height:100vh;background:#020617;color:#e5e7eb;padding:14px;display:flex;flex-direction:column;z-index:9999}#close{position:absolute;top:8px;right:8px;cursor:pointer;opacity:.4}#name,#timer{position:absolute;top:10px;font-size:12px;color:#93c5fd}#name{left:14px}#timer{right:30px}#box{text-align:center;margin-top:24px}.l{font-size:11px;opacity:.6;letter-spacing:.1em}#score{font-size:90px;font-weight:800;color:#facc15}#lists{margin-top:auto;display:flex;width:100%; gap:8px}#lists>div{width:50%;flex:0 0 50%}#pos,#neg{width:100%}h3{text-align:center;font-size:12px;opacity:.7}.item{margin:4px 0;padding:6px;border-radius:8px;font-size:12px;font-weight:700;text-align:center;cursor:pointer}#toast{position:fixed;top:40px;left:0;width:100%;display:flex;justify-content:center;pointer-events:none;z-index:10000}#toast::before{content:attr(data-text);padding:18px 50px;border-radius:28px;font-size:30px;font-weight:800;color:#fff;background:var(--bg);opacity:0;transform:translateY(-20px);transition:.4s}#toast.show::before{opacity:1;transform:none}#mini{position:fixed;top:10px;right:10px;width:34px;height:34px;border-radius:50%;background:#020617;color:#93c5fd;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:9999;box-shadow:0 0 12px rgba(0,0,0,.6)}.pswp{position:fixed!important;left:0!important;top:0!important;width:80vw!important;height:100vh!important;z-index:9998!important}.pswp__bg{width:80vw!important;background:rgba(2,6,23,0.92)!important}.pswp__scroll-wrap,.pswp__container,.pswp__item{width:80vw!important}.pswp__ui{right:auto!important}.pswp__button--fs{display:none!important}`);const open=()=>{panel.style.display="flex";site.style.marginRight="20vw";mini.style.display="none";pref.panelOpen=true;S("listOfStudents",students)};const close=()=>{panel.style.display="none";site.style.marginRight="0";mini.style.display="flex";pref.panelOpen=false;S("listOfStudents",students)};panel.querySelector("#close").onclick=close;mini.onclick=open;pref.panelOpen?open():close();const show=(t,c)=>{toast.dataset.text=t;toast.style.setProperty("--bg",`linear-gradient(135deg,${c},#000a)`);toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),1600)};const scoreEl=panel.querySelector("#score"),pos=panel.querySelector("#pos"),neg=panel.querySelector("#neg");const upd=()=>{scoreEl.textContent=score;pos.innerHTML=neg.innerHTML="";for(let j=9;j>0;j--){let d=document.createElement("div");d.className="item";d.style.background=PC[j];d.textContent=P[j]+" : "+c.p[j];d.onclick=()=>act(j,0);pos.appendChild(d)}for(let j=1;j<=9;j++){let d=document.createElement("div");d.className="item";d.style.background=NC[j];d.textContent=N[j]+" : "+c.n[j];d.onclick=()=>act(j,1);neg.appendChild(d)}};const act=(l,n)=>{n?(c.n[l]++,score-=l,cur.complements.n[l-1]++,show(N[l],NC[l])):(c.p[l]++,score+=l,cur.complements.p[l-1]++,show(P[l],PC[l]));localStorage.setItem("currentClass",JSON.stringify(cur));upd()};const tick=()=>{let n=new Date(),t=new Date(n);n.getMinutes()<30?t.setMinutes(30,0,0):t.setHours(n.getHours()+1,0,0);let d=t-n;panel.querySelector("#timer span").textContent=String(d/6e4|0).padStart(2,0)+":"+String(d%6e4/1e3|0).padStart(2,0)};setInterval(tick,1e3);tick();upd();document.addEventListener("keydown",e=>{/INPUT|TEXTAREA/.test(e.target.tagName)||!/^[1-9]$/.test(e.key)||act(+e.key,e.altKey)})})();
